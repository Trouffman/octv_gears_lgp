#include <libusb-1.0/libusb.h>
#include <stdio.h>
#include <stdlib.h>
#include <memory.h>
#include <unistd.h>

#define CAMERA_VENDOR				0x07ca
#define CAMERA_PRODUCT				0x0875	
#define CAMERA_CONFIGURATION		1
#define CAMERA_INTERACE				0

#define CAMERA_ENDPOINT_ADDRESS_VIDEO_CAPTURE		0x81
#define CAMERA_ENDPOINT_ADDRESS_CONTROL				0x04
#define CAMERA_ENDPOINT_ADDRESS_STATUS_RESPONSE		0x83
#define TIMEOUT	5000

int writecommand(libusb_device_handle *camerahandle, unsigned char* commandbuffer, size_t size) {
	static int transferred = 0;
	int err = libusb_bulk_transfer(camerahandle, CAMERA_ENDPOINT_ADDRESS_CONTROL, commandbuffer, size, &transferred, TIMEOUT);
	if(err != 0) {
		fprintf(stderr, "Error while sending command: '%s' - '%s',  data sent: %i, data transferred: %i, crashing!\n", libusb_error_name(err), libusb_strerror(err), 512, transferred);
		exit(-5);
	} else {
		return 0;
	}
}

int readstatus(libusb_device_handle *camerahandle) {
	static unsigned char buffer[512];
	memset(buffer, 0, 512);
	static int transferred = 0;


	int err = libusb_bulk_transfer(camerahandle, CAMERA_ENDPOINT_ADDRESS_STATUS_RESPONSE, buffer, 512, &transferred, TIMEOUT);

	if(err != 0 && err != LIBUSB_ERROR_TIMEOUT) {
		fprintf(stderr, "Error while reading command: '%s' - '%s' , data received: %i, crashing!\n", libusb_error_name(err), libusb_strerror(err),transferred);
		exit(-5);
	}

	if(transferred == 0) {
		fprintf(stderr,"Status NOT received; TIMEOUT!\n");
	} else {
		fprintf(stderr,"Status received, bytes %i!, value: ", transferred);
		for(size_t i = 0; i < transferred; i++)
			fprintf(stderr,"%.2x ", buffer[i]);
	
		fprintf(stderr,"\n");
	}
	return 0;
}

int readvideostream(libusb_device_handle *camerahandle, FILE *outputfile) {
	static unsigned char buffer[512];
	memset(buffer, 0, 512);
	static int transferred = 0;

	int err = libusb_bulk_transfer(camerahandle, CAMERA_ENDPOINT_ADDRESS_VIDEO_CAPTURE, buffer, 512, &transferred, TIMEOUT);

	if(err != 0) {
		fprintf(stderr,"Error while reading capture stream: '%s' - '%s' , data received: %i, crashing!\n", libusb_error_name(err), libusb_strerror(err),transferred);
		return -1;
	}

	fwrite(buffer, transferred, transferred, outputfile);
	return 0;
}

int main(int argc, char **argv) {
	// Process:
	// 1. Grab USB context
	// 2. Query system devices
	// 3. Figure out which one is the camera
	// 4. Configure the camera
	// 5. Claim interfaces
	// 6. Comm
	// 7. Cleanup


	// 1. Grab USB context
	libusb_context *usbcontext = NULL;
	if(libusb_init(&usbcontext) == 0)
		fprintf(stderr,"We got the context\n");
	else {
		fprintf(stderr,"We DONT have the context\n");
		exit(1);
	}

	libusb_set_debug(usbcontext, LIBUSB_LOG_LEVEL_WARNING);

	
	// 2. Query system devices
	libusb_device **devicelist;
	size_t devicecount = libusb_get_device_list(usbcontext, &devicelist);
	if(devicecount < 0) {
		fprintf(stderr,"Error when counting devices!\n");
		exit(-1);
	}

	// 3. Figure out which one is the camera
	libusb_device_handle *camerahandle = NULL;
	for(size_t i = 0; i < devicecount; i++) {
		libusb_device *dev = devicelist[i];	
		struct libusb_device_descriptor desc;
		libusb_get_device_descriptor(dev, &desc);

		if(desc.idVendor == CAMERA_VENDOR && desc.idProduct == CAMERA_PRODUCT) {
			fprintf(stderr,"Found camera!\n");
			if(libusb_open(dev, &camerahandle) != 0) {
				fprintf(stderr,"Error getting the handle!\n");
				camerahandle = NULL;
			}
		}
	}


	if(camerahandle == NULL) {
		fprintf(stderr,"Couldn't obtain camera handle.\n");
		exit(-2);
	}


	// 4. Configure the camera
	if(libusb_set_configuration(camerahandle, CAMERA_CONFIGURATION) != 0) {
		fprintf(stderr,"Failed to set configuration!\n");
		exit(-3);
	}


	// 5. Claim interfaces
	if(libusb_claim_interface(camerahandle, CAMERA_INTERACE) != 0) {
		fprintf(stderr,"Failed to claim interface!\n");
		exit(-4);
	}

	// 6. Comm

	unsigned char id_00100[] = { 0x0b, 0x01, 0x02, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2c, 0x0b  };
	size_t id_00100_s = 10;	
	unsigned char id_00101[] = { 0x0b, 0x01, 0x02, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2c, 0x03  };
	size_t id_00101_s = 10;	
	unsigned char id_00102[] = { 0x0b, 0x01, 0x02, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2c, 0x05  };
	size_t id_00102_s = 10;

/* UNUSED
	char id_00103[] = { 0x01, 0x01, 0x01, 0x00, 0xF8, 0x06, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00  };
	size_t id_00103_s = 12;
	char id_00104[] = { 0x01, 0x01, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00  };
	size_t id_00104_s = 12;
	char id_00105[] = { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00  };
	size_t id_00105_s = 12;
	char id_00106[] = { 0x0B, 0x01, 0x02, 0x00, 0x15, 0x00, 0x00, 0x00, 0x3A, 0x03  };
	size_t id_00106_s = 10;
 	char id_00107[] = { 0x0C, 0x01, 0x01, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2B  };
	size_t id_00107_s = 9;
	char id_00108[] = { 0x0C, 0x01, 0x01, 0x00, 0x15, 0x00, 0x00, 0x00, 0x3E  };
	size_t id_00108_s = 9;
 	char id_00109[] = { 0x0C, 0x01, 0x01, 0x00, 0x15, 0x00, 0x00, 0x00, 0x1B  };
	size_t id_00109_s = 9;
 	char id_00110[] = { 0x0C, 0x01, 0x01, 0x00, 0x15, 0x00, 0x00, 0x00, 0x1C  };
	size_t id_00110_s = 9;
 	char id_00111[] = { 0x0C, 0x01, 0x01, 0x00, 0x15, 0x00, 0x00, 0x00, 0x25  };
	size_t id_00111_s = 9;
 	char id_00112[] = { 0x0C, 0x01, 0x07, 0x00, 0x15, 0x00, 0x00, 0x00, 0x1D  };
	size_t id_00112_s = 9;
 	char id_00113[] = { 0x0C, 0x01, 0x01, 0x00, 0x15, 0x00, 0x00, 0x00, 0x37  };
	size_t id_00113_s = 9;
 	char id_00114[] = { 0x0C, 0x01, 0x01, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2D  };
	size_t id_00114_s = 9;
 	char id_00115[] = { 0x0C, 0x01, 0x01, 0x00, 0x15, 0x00, 0x00, 0x00, 0x26  };
	size_t id_00115_s = 9;
 	char id_00116[] = { 0x0C, 0x01, 0x01, 0x00, 0x15, 0x00, 0x00, 0x00, 0x24  };
	size_t id_00116_s = 9;
 	char id_00117[] = { 0x0C, 0x01, 0x01, 0x00, 0x15, 0x00, 0x00, 0x00, 0x13  };
	size_t id_00117_s = 9;
	char id_00118[] = { 0x0B, 0x01, 0x06, 0x00, 0x15, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0xB0, 0x01, 0x01  };
	size_t id_00118_s = 14;
	char id_00119[] = { 0x0B, 0x01, 0x06, 0x00, 0x15, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0xAF, 0x01, 0x01  };
	size_t id_00119_s = 14;
	char id_00120[] = { 0x0B, 0x01, 0x06, 0x00, 0x15, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0xAC, 0x01, 0x01  };
	size_t id_00120_s = 14;
	char id_00121[] = { 0x0B, 0x01, 0x02, 0x00, 0x15, 0x00, 0x00, 0x00, 0x47, 0x01  };
	size_t id_00121_s = 10;
	char id_00122[] = { 0x0B, 0x01, 0x02, 0x00, 0x15, 0x00, 0x00, 0x00, 0x3A, 0x02  };
	size_t id_00122_s = 10;
	char id_00123[] = { 0x0B, 0x01, 0x02, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2E, 0x06  };
	size_t id_00123_s = 10;
	char id_00124[] = { 0x0B, 0x01, 0x02, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2E, 0x05  };
	size_t id_00124_s = 10;
	char id_00125[] = { 0x0B, 0x01, 0x02, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2E, 0x04  };
	size_t id_00125_s = 10;
	char id_00126[] = { 0x05, 0x01, 0x02, 0x00, 0x35, 0x00, 0x00, 0x00, 0x5A, 0x01  };
	size_t id_00126_s = 10;
	char id_00127[] = { 0x05, 0x01, 0x02, 0x00, 0x35, 0x00, 0x00, 0x00, 0x1D, 0x00  };
	size_t id_00127_s = 10;
	char id_00128[] = { 0x05, 0x01, 0x02, 0x00, 0x35, 0x00, 0x00, 0x00, 0x1C, 0x49  };
	size_t id_00128_s = 10;
	char id_00129[] = { 0x05, 0x01, 0x02, 0x00, 0x35, 0x00, 0x00, 0x00, 0x15, 0xEC  };
	size_t id_00129_s = 10;
	char id_00130[] = { 0x05, 0x01, 0x02, 0x00, 0x35, 0x00, 0x00, 0x00, 0x14, 0x1F  };
	size_t id_00130_s = 10;
	char id_00131[] = { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0xF2, 0x00, 0x00, 0x00  };
	size_t id_00131_s = 12;
	char id_00132[] = { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0xF1, 0x00, 0x00, 0x00  };
	size_t id_00132_s = 12;
	char id_00133[] = { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00  };
	size_t id_00133_s = 12;
	char id_00134[] = { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00  };
	size_t id_00134_s = 12;
	char id_00136[] = { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00  };
	size_t id_00136_s = 12;
	char id_00137[] = { 0x01, 0x01, 0x01, 0x00, 0xF8, 0x06, 0x00, 0x00, 0x83, 0x00, 0x00, 0x00  };
	size_t id_00137_s = 12;
	char id_00138[] = { 0x01, 0x01, 0x01, 0x00, 0xF8, 0x06, 0x00, 0x00, 0x19, 0xC2, 0x01, 0x21  };
	size_t id_00138_s = 12;
	char id_00139[] = { 0x01, 0x01, 0x01, 0x00, 0xF4, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00  };
	size_t id_00139_s = 12;
	char id_00140[] = { 0x01, 0x01, 0x01, 0x00, 0xF0, 0x06, 0x00, 0x00, 0xAA, 0xAA, 0xAA, 0x2A  };
	size_t id_00140_s = 12;
	char id_00141[] = { 0x01, 0x01, 0x01, 0x00, 0xF0, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00  };
	size_t id_00141_s = 12;
	char id_00142[] = { 0x01, 0x01, 0x01, 0x00, 0xEC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00  };
	size_t id_00142_s = 12;
	char id_00143[] = { 0x01, 0x01, 0x01, 0x00, 0xEC, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00  };
	size_t id_00143_s = 12;
	char id_00144[] = { 0x01, 0x01, 0x01, 0x00, 0xE4, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00  };
	size_t id_00144_s = 12;
	char id_00145[] = { 0x01, 0x01, 0x01, 0x00, 0xC8, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00  };
	size_t id_00145_s = 12;
	char id_00146[] = { 0x01, 0x01, 0x01, 0x00, 0x00, 0x08, 0x00, 0x00, 0x07, 0x00, 0x01, 0x00  };
	size_t id_00146_s = 12;
	char id_00147[] = { 0x01, 0x00, 0x07, 0x00, 0xB0, 0x06, 0x00, 0x00  };
	size_t id_00147_s = 8;
	char id_00148[] = { 0x01, 0x00, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00  };
	size_t id_00148_s = 8;
	char id_00149[] = { 0x01, 0x00, 0x01, 0x00, 0x18, 0x06, 0x00, 0x00  };
	size_t id_00149_s = 8;
*/	


	// Boot
	fprintf(stderr,"Init procedure...\n");
	writecommand(camerahandle, id_00100, id_00100_s);
	readstatus(camerahandle);
	sleep(1);

	writecommand(camerahandle, id_00101, id_00101_s);
	readstatus(camerahandle);
	sleep(1);

	writecommand(camerahandle, id_00102, id_00102_s);
	readstatus(camerahandle);
	sleep(1);
	fprintf(stderr,"Done\n");


	struct commandframe {
		size_t size;
		unsigned char command[64];
	};

	// Try to start streaming	
	struct commandframe capturepackets[] = {
		// {10, { 0x0B, 0x01, 0x02, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2C, 0x0B }	},
		// {10, { 0x0b, 0x01, 0x02, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2c, 0x03 }	},
		// {10, { 0x0b, 0x01, 0x02, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2c, 0x05 }	},
		// Procedure test #1 - Source : UTL005 from start till the first data received on EP81
		{ 8, {0x01, 0x00, 0x01, 0x00, 0x18, 0x06, 0x00, 0x00 } },
		{ 8, {0x01, 0x00, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00 } },
		{ 9, { 0x0C, 0x01, 0x01, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2B } },
		{ 10, { 0x0B, 0x01, 0x02, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2B, 0x00 } },
		{ 10, { 0x0B, 0x01, 0x02, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2C, 0x0B } },
		{ 10, { 0x0B, 0x01, 0x02, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2C, 0x03 } },
		{ 10, { 0x0B, 0x01, 0x02, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2C, 0x05 } },
		{ 14, { 0x0B, 0x01, 0x06, 0x00, 0x15, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0xAF, 0x01, 0x01 } },
		{ 9, { 0x0C, 0x01, 0x01, 0x00, 0x15, 0x00, 0x00, 0x00, 0x13 } },
		{ 14, { 0x0B, 0x01, 0x06, 0x00, 0x15, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0xAC, 0x01, 0x01 } },
		{ 9, { 0x0C, 0x01, 0x01, 0x00, 0x15, 0x00, 0x00, 0x00, 0x13 } },
		{ 14, { 0x0B, 0x01, 0x06, 0x00, 0x15, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0xB0, 0x01, 0x01 } },
		{ 9, { 0x0C, 0x01, 0x01, 0x00, 0x15, 0x00, 0x00, 0x00, 0x13 } },
		{ 8, {0x01, 0x00, 0x01, 0x00, 0x18, 0x06, 0x00, 0x00 } },
		{ 8, {0x01, 0x00, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF8, 0x06, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00 } },
		{ 8, {0x01, 0x00, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF8, 0x06, 0x00, 0x00, 0x11, 0x00, 0x00, 0x80 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0xF1, 0x00, 0x00, 0x00 } },
		{ 8, {0x01, 0x00, 0x01, 0x00, 0x00, 0x08, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0x00, 0x08, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00 } },
		{ 8, {0x01, 0x00, 0x01, 0x00, 0x00, 0x08, 0x00, 0x00 } },
		{ 8, {0x01, 0x00, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF8, 0x06, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0xF2, 0x00, 0x00, 0x00 } },
		{ 8, {0x01, 0x00, 0x01, 0x00, 0x00, 0x08, 0x00, 0x00 } },
		{ 10, { 0x05, 0x01, 0x02, 0x00, 0x35, 0x00, 0x00, 0x00, 0x14, 0x1F } },
		{ 8, {0x01, 0x00, 0x01, 0x00, 0x00, 0x08, 0x00, 0x00 } },
		{ 10, { 0x05, 0x01, 0x02, 0x00, 0x35, 0x00, 0x00, 0x00, 0x15, 0xEC } },
		{ 10, { 0x05, 0x01, 0x02, 0x00, 0x35, 0x00, 0x00, 0x00, 0x1C, 0x49 } },
		{ 10, { 0x05, 0x01, 0x02, 0x00, 0x35, 0x00, 0x00, 0x00, 0x1D, 0x00 } },
		{ 10, { 0x05, 0x01, 0x02, 0x00, 0x35, 0x00, 0x00, 0x00, 0x5A, 0x01 } },
		{ 8, {0x01, 0x00, 0x01, 0x00, 0x00, 0x08, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF8, 0x06, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF4, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF0, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 } },
		{ 8, {0x01, 0x00, 0x01, 0x00, 0x00, 0x08, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF8, 0x06, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00 } },
		{ 8, {0x01, 0x00, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF4, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF0, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xEC, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF8, 0x06, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF4, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF8, 0x06, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF4, 0x06, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF0, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xEC, 0x06, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF8, 0x06, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF4, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF0, 0x06, 0x00, 0x00, 0x38, 0x4A, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF8, 0x06, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF4, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF0, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF8, 0x06, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF4, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF8, 0x06, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF4, 0x06, 0x00, 0x00, 0xDA, 0xF1, 0xF1, 0xF1 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF0, 0x06, 0x00, 0x00, 0xB6, 0xF1, 0xF1, 0xB6 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF8, 0x06, 0x00, 0x00, 0x19, 0xC2, 0x01, 0x21 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF4, 0x06, 0x00, 0x00, 0x80, 0x07, 0x38, 0x04 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF0, 0x06, 0x00, 0x00, 0x09, 0x06, 0x7C, 0x0F } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xEC, 0x06, 0x00, 0x00, 0x30, 0x75, 0x78, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xE8, 0x06, 0x00, 0x00, 0xD0, 0x07, 0x40, 0x1F } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xE4, 0x06, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xE0, 0x06, 0x00, 0x00, 0x1E, 0x00, 0x99, 0xF1 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xD8, 0x06, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xDC, 0x06, 0x00, 0x00, 0x80, 0x07, 0x38, 0x04 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xD4, 0x06, 0x00, 0x00, 0x80, 0x10, 0x16, 0x21 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xD0, 0x06, 0x00, 0x00, 0xF4, 0x40, 0x08, 0x52 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xF8, 0x06, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xCC, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xFC, 0x06, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0x00, 0x08, 0x00, 0x00, 0x07, 0x00, 0x01, 0x00 } },
		{ 8, { 0x01, 0x00, 0x07, 0x00, 0xB0, 0x06, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xC8, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 } },
		{ 16, { 0x09, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8F, 0x66, 0x00, 0x00, 0x80, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0x00, 0x08, 0x00, 0x00, 0x07, 0x00, 0x01, 0x00 } },
		{ 8, { 0x01, 0x00, 0x07, 0x00, 0xB0, 0x06, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xC8, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0x00, 0x08, 0x00, 0x00, 0x07, 0x00, 0x01, 0x00 } },
		{ 8, { 0x01, 0x00, 0x07, 0x00, 0xB0, 0x06, 0x00, 0x00 } },
		// { 12, { 0x01, 0x01, 0x01, 0x00, 0xC8, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 } }

		/* DO NOT REMOVE THIS LAST ONE! */
		{ 0, { 0x0 } }
	};

	size_t capturepacketcount = 0;
	for(size_t i = 0; capturepackets[i].size != 0; i++)
		capturepacketcount++;

	fprintf(stderr,"Count done, %i packets to send; sending the capture command packets...\n", capturepacketcount);
	for(size_t i = 0; i < capturepacketcount; i++) {
		// Please add a debug to have the output of the command sent please. 
		// Note Trouff : i dunno how to print the data sent for debugging purpose only.
		fprintf(stderr,"Sending : step %zu with size %zu & data : ", i, capturepackets[i].size);
		for(size_t j = 0; j < capturepackets[i].size; j++)
			fprintf(stderr,"%.2x ", capturepackets[i].command[j]);
		fprintf(stderr,"\n");

		writecommand(camerahandle, capturepackets[i].command, capturepackets[i].size);
		readstatus(camerahandle);
	//	sleep(5);
	}

	fprintf(stderr,"Capture stream sent, will try to capture stuff on other endpoint now...\n");
	FILE *outputfile = fopen("capture.h264", "wb");
	if(outputfile != NULL) { 
		int running = 1;
		while(running) {
			int err = readvideostream(camerahandle, outputfile);
			if(err != 0) {
				running = 0;
				fprintf(stderr,"ERROR WITH STREAM CAPTURE, ABORT!\n");
			}
		}
	} else {
		fprintf(stderr,"Failed to open capture file, obviously - aborting!\n");
	}	

	// 7. Cleanup
	if(outputfile != NULL) {
		fprintf(stderr,"Closing capture file...\n");
		fclose(outputfile);
	}

	fprintf(stderr,"Closing handles...\n");
	libusb_release_interface(camerahandle, CAMERA_INTERACE);
	libusb_close(camerahandle);
	libusb_free_device_list(devicelist, 1); // 1 = unref devices
	libusb_exit(usbcontext);
	fprintf(stderr,"Bye\n");
	return 0;
}
